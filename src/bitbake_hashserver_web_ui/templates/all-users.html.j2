<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./static/bootstrap-5.3.2-dist/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./static/common.css"/>
        <title>Hash Equivalence Server User Management</title>
        <script src="./static/common.js"></script>
        <script>
            const ALL_PERMS = ['{{ all_perms | join("', '") | safe }}'];
            const ADMIN_USER = '{{ admin_user }}';
            const CURRENT_USER = '{{ user["username"] }}';

            function get_perm_checkbox(prefix, perm) {
                const id = `${prefix}-${perm}`;
                let cb = document.getElementById(id);
                if (!cb) {
                    console.log("Cannot find checkbox %s", id);
                }
                return cb;
            }

            function get_perms(prefix) {
                let perms = [];
                for (let p in ALL_PERMS) {
                    let cb = get_perm_checkbox(prefix, ALL_PERMS[p]);
                    if (cb.checked) {
                        perms.push(ALL_PERMS[p]);
                    }
                }
                if (perms.length == 0) {
                    return ["@none"];
                }
                return perms;
            }

            function on_update_user_perms_click(username) {
                user_set_perms(username, get_perms(username), function (data) {
                    if ("error" in data) {
                        live_alert("danger", data["error"]);
                    } else {
                        const username = data["username"];
                        const user_perms = data["permissions"];
                        for (let p in ALL_PERMS) {
                            let cb = get_perm_checkbox(username, ALL_PERMS[p]);
                            if (cb) {
                                cb.checked = user_perms.includes(ALL_PERMS[p]);
                            }
                        }
                    }
                });
            }

            function on_delete_click(username) {
                if (window.confirm(`Are you sure you want to delete user ${username}?\nThis action cannot be undone`)) {
                    user_delete(username, function (data) {
                        if ("error" in data) {
                            live_alert("danger", data["error"]);
                        } else {
                            live_alert("success", `User <span class="username">${escapeHTML(username)}</span> deleted`);
                            update_user_table();
                        }
                    });
                }
            }

            function show_token_alert(username, token) {
                live_alert("success", [
                    `<p>New token for user <span class="username">${escapeHTML(username)}</span> is:</p>`,
                    `<p><span class="token">${escapeHTML(token)}</span></p>`
                ].join(""));
            }

            function on_reset_click(username) {
                if (window.confirm(`Are you sure you want to reset the token for user ${username}?\nThis will invalidate the current token and cannot be undone`)) {
                    user_reset_token(username, function (data) {
                        if ("error" in data) {
                            live_alert("danger", data["error"]);
                        } else {
                            show_token_alert(data["username"], data["token"]);
                        }
                    });
                }
            }

            function on_create_new_user_click() {
                const username = document.getElementById("new-user-name").value;
                const perms = get_perms("new-user");
                if (!username) {
                    return;
                }

                user_create(username, perms, function (data) {
                    if ("error" in data) {
                        live_alert("danger", data["error"]);
                    } else {
                        show_token_alert(data["username"], data["token"]);
                        update_user_table();
                    }
                });
            }

            function update_user_table() {
                get_all_users(function (data) {
                    if ("error" in data) {
                        live_alert("danger", data["error"]);
                        return;
                    }

                    const users = data.users.sort(function (a, b) {
                        return a.username.localeCompare(b.username);
                    });

                    const table = document.getElementById("user-table");
                    let tbody = document.createElement("tbody");

                    for (let idx in users) {
                        const user = users[idx];
                        let row = tbody.insertRow();

                        row.insertCell().innerHTML = `<span class="username">${escapeHTML(user.username)}</span>`;

                        for (let p in ALL_PERMS) {
                            let text = [
                                '<div class="form-check form-switch">',
                                '<input class="form-check-input" role="switch" type="checkbox"',
                                `   id="${user.username}-${ALL_PERMS[p]}"`,
                                `   onclick='on_update_user_perms_click("${user.username}")'`,
                            ];
                            if ( user.username == ADMIN_USER || ( ALL_PERMS[p] == "@user-admin" && user.username == CURRENT_USER ) ) {
                                text.push("disabled");
                            }
                            if ( user.permissions.includes(ALL_PERMS[p]) ) {
                                text.push("checked");
                            }
                            text.push("/></div>");

                            row.insertCell().innerHTML = text.join(" ");
                        }

                        let reset_text = [
                            '<button',
                            '   class="btn btn-warning"',
                            `   onclick='on_reset_click("${user.username}")'`,
                        ];
                        if ( user.username == ADMIN_USER) {
                            reset_text.push("disabled");
                        }
                        reset_text.push(">Reset Token</button>");

                        row.insertCell().innerHTML = reset_text.join(" ");

                        let delete_text = [
                            '<button',
                            '   class="btn btn-danger"',
                            `   onclick='on_delete_click("${user.username}")'`,
                        ];
                        if ( user.username == ADMIN_USER || user.username == CURRENT_USER ) {
                            delete_text.push("disabled");
                        }
                        delete_text.push(">Delete</button>");

                        row.insertCell().innerHTML = delete_text.join(" ");
                    }

                    table.replaceChild(tbody, table.tBodies[0]);
                });

            }
        </script>
    </head>
    <body onload='update_user_table()'>
        {% include "nav-bar.html.j2" %}
        <div class="container">
            <h1>User Administration</h1>
        </div>
        <div class="container">
            <h3>Users</h3>
            <table class="table" id="user-table">
                <thead>
                    <tr>
                        <th rowspan="2">Username</th>
                        <th colspan="{{ all_perms | length }}">Permissions</th>
                        <th rowspan="2"/>
                        <th rowspan="2"/>
                    </tr>
                    <tr>
                        {% for perm in all_perms %}
                        <th> {{ perm }} </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="container">
            <h3>Add new user</h3>
        </div>
        <div class="container">
            <div class="input-group mb-3">
                <span class="input-group-text">New username</span>
                <input class="form-control" id="new-user-name" autocomplete="off"/>
            </div>
        </div>
        <div class="container">
            Permissions:
            {% for perm in all_perms %}
            <div class="form-check form-switch">
                <input 
                    class="form-check-input"
                    role="switch"
                    type="checkbox" 
                    id="new-user-{{ perm }}"
                    {% if perm in default_perms %}checked{% endif %}
                />
                <label class="form-check-label" for="new-user-{{ perm }}"><span class="perm">{{ perm }}</span></label>
            </div>
            {% endfor %}
        </div>
        <div class="container">
            <button class="btn btn-outline-primary" onclick='on_create_new_user_click()'>Create New User</button>
        </div>
        <div class="container">
            <div id="liveAlertPlaceholder"></div>
        </div>
        <script src="./static/bootstrap-5.3.2-dist/js/bootstrap.min.js"></script>
    </body>
</html>

